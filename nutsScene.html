<!DOCTYPE html>
<html lang="en">

<head>
    <title>Nuts Scene</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    
    <style type="text/css">
    #nutsScene {
        margin-top: 100px;
    }
    
    #yuppie {
        margin-top: 100px;
    }

    .center {
        margin: auto;
        text-align: center;
        font-size: 70px;
    }

    h1 {
        margin-top: 30px;
        font-size: 70px;
        font-family: century;
    }

    body {
        pointer-events: none;
        background-color: black;
        color: white;
    }
    </style>

</head> 

<body>
    <h1 class="center">Nuts Scene</h1>
    <div id="nutsScene"class="col-sm-12 col-md-6 center">
        THE
    </div>

    <div id="yuppie" class="col-sm-12 col-md-6 center">   
        END
    </div>

    <script>
        // 2. This code loads the IFrame Player API code asynchronously.
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);


        // 3. This function creates an <iframe> (and YouTube player)
        //    after the API code downloads.
        var nutsScene;
        var yuppie;
        var yuppieData = {
            'id': 'yuppie', 
            'videoId': "iOntet85kBw", 
            'start': null, 
            'end': null,
            yuppieVidIds: [
                "iOntet85kBw", 
                "tke5v9uW820",
                "eVDJvtGinb0", 
                "4GZPuLfAn-4", 
                "n5yaKQGdYuQ"
            ],
            nextVidIdIndex: 1
        };
        var nutsSceneData = {
            'id': 'nutsScene',
            'videoId': 'xLyyHu5GSrM', 
            'start': 69, 
            'end': 172 
        };

        function onYouTubeIframeAPIReady() {
            nutsScene = createiFramePlayer(nutsSceneData);
            yuppie = createiFramePlayer(yuppieData);
        }

        function createiFramePlayer(playerData){
            return new YT.Player(playerData.id, {
            playerVars: { 'autoplay': 1, 'controls': 0, 'start': playerData.start, 'end': playerData.end, 'mute': 1},
            videoId: playerData.videoId,
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
            });
        }

        // 4. The API will call this function when the video player is ready.
        function onPlayerReady(event) {
            if (event.target.getVideoData().video_id === yuppieData.videoId){
                event.target.setVolume(30);
            }
            event.target.playVideo();
        }

        // 5. The API calls this function when the player's state changes.
        var done = false;
        function onPlayerStateChange(event) {
            console.log(event.target.isMuted());
            if(event.target.isMuted()){
                nutsScene.unMute();
                yuppie.unMute();
            }
            if (event.data === YT.PlayerState.ENDED && !done) {
                if (event.target.getVideoData().video_id === yuppieData.videoId && 
                yuppieData.nextVidIdIndex === yuppieData.yuppieVidIds.length) { 
                    // end
                    done = true;
                    yuppie.destroy();
                    nutsScene.destroy();
                } else if (event.target.getVideoData().video_id === nutsSceneData.videoId){
                    // Replay nuts Scene
                    nutsScene.loadVideoById({
                        videoId: nutsSceneData.videoId,
                        startSeconds: nutsSceneData.start,
                        endSeconds: nutsSceneData.end
                    });
                } else { 
                    // play next yuppie vid
                    yuppieData.videoId = yuppieData.yuppieVidIds[yuppieData.nextVidIdIndex];
                    yuppieData.nextVidIdIndex++; 
                    yuppie.loadVideoById({
                        videoId: yuppieData.videoId,
                    });                    
                }
            }
        }
    </script>
</body>
